<!DOCTYPE html>
<html>
<head>
    <title>Rastreo de Mascotas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100%; }
        .custom-icon { width: 32px !important; height: 32px !important; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Mapa y capas
        var map = L.map('map').setView([19.4326, -99.1332], 13);
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        streetLayer.addTo(map);

        // Control de capas
        L.control.layers({ "Calle": streetLayer, "Satélite": satelliteLayer }).addTo(map);

        // Variables para rastreo
        var hunterMarker, hunterPolyline, hunterLatLngs = [];
        var pets = {}; // Almacena datos de mascotas: { id: { marker, polyline, color } }

        // Función para actualizar cazador
        function updateHunter(lat, lng) {
            if (!hunterMarker) {
                hunterMarker = L.marker([lat, lng], { 
                    icon: L.icon({ 
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        className: 'custom-icon'
                    }) 
                }).addTo(map);
                hunterPolyline = L.polyline([], { color: 'red' }).addTo(map);
            }
            hunterMarker.setLatLng([lat, lng]);
            hunterLatLngs.push([lat, lng]);
            hunterPolyline.setLatLngs(hunterLatLngs);
        }

        // Función para actualizar mascotas
        function updatePet(id, lat, lng, color = '#FF00FF', iconUrl = 'default-icon.png') {
            if (!pets[id]) {
                pets[id] = {
                    marker: L.marker([lat, lng], { 
                        icon: L.icon({ 
                            iconUrl: iconUrl,
                            className: 'custom-icon'
                        }) 
                    }).addTo(map),
                    polyline: L.polyline([], { color: color }).addTo(map),
                    latLngs: []
                };
            }
            pets[id].marker.setLatLng([lat, lng]);
            pets[id].latLngs.push([lat, lng]);
            pets[id].polyline.setLatLngs(pets[id].latLngs);
        }

        // Resetear todo
        function resetAll() {
            if (hunterMarker) map.removeLayer(hunterMarker);
            if (hunterPolyline) map.removeLayer(hunterPolyline);
            hunterLatLngs = [];
            Object.values(pets).forEach(pet => {
                map.removeLayer(pet.marker);
                map.removeLayer(pet.polyline);
            });
            pets = {};
        }

        // Exponer funciones para Kodular
        window.updateHunter = updateHunter;
        window.updatePet = updatePet;
        window.resetAll = resetAll;
    </script>
</body>
</html>
